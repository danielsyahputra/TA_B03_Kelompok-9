<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <object th:include="fragments/fragment2 :: materializecss" th:remove="tag"></object>
    <object th:include="fragments/fragment2 :: js" th:remove="tag"></object>
    <object th:include="fragments/fragment2 :: title (current='Detail Cabang')" th:remove="tag"></object>
</head>

<body>
    <div th:replace="fragments/fragment2 :: navbar"></div>
    <div class="container">
        <h3 class="center-align grey-text text-darken-1">Detail Cabang</h3>

        <!-- Error -->
        <div class="card-panel green-text text-darken-1" th:text="${success}" th:if="${success != null}"></div>
        <div class="card-panel red-text text-darken-1" th:text="${error}" th:if="${error != null}"></div>

        <div class="card-panel">
            <h5 th:text="'Cabang ID ' + ${cabang.id}"></h5>
            <p th:text="'Nama: ' + ${cabang.nama}"></p>
            <p th:text="'No Telepon: ' + ${cabang.nomorTelepon}"></p>
            <p th:text="'Alamat: ' + ${cabang.alamat}"></p>
            <p th:text="'Ukuran: ' + ${cabang.ukuran} +'m^2'"></p>
        </div>

        <!---->
        <a th:if="${user.role.role != 'Staff Cabang'}" type="button"
           class="waves-effect waves-light btn-small" id="tambah-item">Tambah Item</a>

        <!-- Loader -->
        <div class="" id="loader2">
            <div class="indeterminate"></div>
        </div>

        <div th:if="${listItem.size() != 0}">
            <h5>List Item:</h5>
            <table class="responsive-table striped">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Id Item</th>
                        <th>Nama</th>
                        <th>Harga</th>
                        <th th:if="${user.role.role != 'Staff Cabang'}">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item, iterationStatus : ${listItem}">
                        <td th:text="${iterationStatus.count}"></td>
                        <td th:text="${item.id}"></td>
                        <td th:text="${item.nama}"></td>
                        <td th:text="${item.harga}"></td>
                        <td th:if="${user.role.role != 'Staff Cabang'}">
                            <a th:if="${!punyaKupon[__${iterationStatus.index}__]}"
                               type="button"
                               class="waves-effect waves-light btn-small button-kupon">Terapkan Kupon</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Loader 1-->
        <div class="" id="loader">
            <div class="indeterminate"></div>
        </div>

        <!--Kupon Kontainer-->
        <div class="card-panel" id="kupon-container"></div>

        <!--Button-->
        <a th:if="${user.getRole().getRole() == 'Kepala Retail'}" th:href="@{/cabang/ubah/} + ${cabang.id}"
           class="waves-effect waves-light btn-small lime edit-btn">
            <i class="material-icons">edit</i>
        </a>
        <a th:href="@{/cabang/viewall}" class="waves-effect waves-light btn indigo lighten-1">
            Kembali
        </a>
    </div>


    <object th:include="fragments/fragment2 :: materializejs" th:remove="tag"></object>
    <object th:include="fragments/fragment2 :: tambahan" th:remove="tag"></object>
    <script >

        const tambahkanKupon = (kupon, idItem) => {
            const buttonTambah = $(`#btn-kupon-${kupon.idCoupon}`)
            buttonTambah.click(() => {
                let APILink = location.origin + `/api/v1/item/${idItem}`
                $.ajax({
                    url: APILink,
                    type: "PUT",
                    data: {
                        "jumlahDiskon": kupon.discountAmount,
                        "idPromo": kupon.idCoupon
                    },
                    beforeSend: () => {
                        console.log("MENGIRIM");
                    },
                    success: response => {
                        alert("Berhasil menambahkan diskon!");
                        location.reload();
                    }
                })
            })
        }

        const loadKupon = (kupon, idItem) => {
            console.log(kupon);
            let id = kupon.idCoupon;
            let kodeKupon = kupon.couponCode;
            let jumlahDiskon = kupon.discountAmount;
            const HTMLText = `
                <div class="card-body">
                    ${kodeKupon} <span style="color: red">(${jumlahDiskon}$)</span>
                    <button class="btn btn-success" id="btn-kupon-${id}">Tambahkan</button>
                </div>
                <br>
            `
            $("#kupon-container").append(HTMLText);
            tambahkanKupon(kupon, idItem);
        }

        const loadData = (response, idItem) => {
            const res = JSON.parse(response);
            const kupons = res.result;
            kupons.forEach(kupon => {
                loadKupon(kupon, idItem);
            })
        }

        const getKupon = (idItem) => {
            let APILink = location.origin + "/api/v1/kupon";
            $.ajax({
                url: APILink,
                type: "GET",
                beforeSend: () => {
                    console.log("AMBIL DATA");
                    $("#kupon-container").empty();
                    $("#loader").addClass("progress");
                },
                success: response => {
                    $("#loader").removeClass("progress");
                    loadData(response, idItem);
                }
            })
        }

        const terapkanButtons = document.querySelectorAll(".button-kupon");
        terapkanButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                let row = btn.parentElement.parentElement;
                let id = row.children[1].innerHTML;
                getKupon(id)
            })
        })

        const loadItems = response => {
            const res = JSON.parse(response);
            console.log(res);
        }

        const getItems = () => {
            let APILink = location.origin + "/api/v1/item";
            $.ajax({
                url: APILink,
                type: "GET",
                beforeSend: () => {
                    $("#loader2").addClass("progress");
                    console.log("GET ITEMS");
                },
                success: response => {
                    $("#loader2").removeClass("progress");
                    loadItems(response);
                }
            })
        }

        $("#tambah-item").click(() => {
            getItems();
        })

    </script>
</body>
</html>